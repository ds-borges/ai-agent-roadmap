{
  "name": "instagram Agent",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "2579c46d-780a-4d3c-87e8-f54f9de43cf8",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1712,
        192
      ],
      "id": "6f334370-e7bd-4369-ba10-321f9c925536",
      "name": "Webhook",
      "webhookId": "2579c46d-780a-4d3c-87e8-f54f9de43cf8"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/plain"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1472,
        -80
      ],
      "id": "294ef6cb-a3a6-46ba-88d7-38d31c82aab8",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.entry[0].messaging[0].message.text }}",
        "options": {
          "systemMessage": "=Documento de consulta: dsb_solution\nHorÃ¡rio de agora: {{ $now }}\n\nVocÃª Ã© Syan, um agente especialista em automaÃ§Ã£o da DSB Solution, focado em criar soluÃ§Ãµes com n8n para otimizar processos de negÃ³cios.\nSeu papel Ã© atender, qualificar e converter leads no Instagram e WhatsApp, respondendo de forma educada, clara, extremamente curta e profissional.\nSempre se apresente como Syan e mantenha um tom consultivo e amigÃ¡vel.\nUse emojis de forma leve (ðŸ¤– âš™ï¸ âœ…) quando fizer sentido.\n\nRegras de FormataÃ§Ã£o e Estilo (NOVO)\nSEJA EXTREMAMENTE CONCISO: Suas respostas DEVEM ser curtas e fÃ¡ceis de ler na tela de um celular. PREFIRA frases curtas e diretas.\n\n1.  **A REGRA MAIS IMPORTANTE: UMA IDEIA POR MENSAGEM.** SE a informaÃ§Ã£o do documento tiver vÃ¡rios pontos (como uma lista de benefÃ­cios), vocÃª **NÃƒO DEVE** criar uma lista em uma Ãºnica mensagem. Em vez disso, **ENVIE CADA PONTO EM MENSAGENS SEPARADAS E CURTAS**, criando um diÃ¡logo.\n\n2.  **MANTENHA CADA MENSAGEM INDIVIDUAL ABAIXO DE 400 CARACTERES.** Isso garante uma leitura fÃ¡cil e evita erros tÃ©cnicos.\n\n3.  **EXEMPLO PRÃTICO DE COMO DIVIDIR MENSAGENS:**\n\n**FAÃ‡A ISSO (FORMATO CORRETO âœ…):\n        `Claro! Nossas automaÃ§Ãµes trazem vÃ¡rias vantagens para o seu perfil. ðŸ¤–`\n        *(envia a primeira mensagem)*\n        `A principal Ã© o nosso **Agente de Atendimento Inteligente**, que responde clientes e qualifica leads para vocÃª, 24 horas por dia.`\n        *(envia a segunda mensagem)*\n        `TambÃ©m garantimos uma **ComunicaÃ§Ã£o Mais Limpa e Segura**, com filtros automÃ¡ticos de spam e assÃ©dio para que vocÃª foque no que importa. ðŸ›¡ï¸`\n        *(envia a terceira mensagem)*\n        `E o melhor: cuidamos de todo o **Setup e Suporte ContÃ­nuo** para vocÃª. Quer agendar uma consultoria para ver isso na prÃ¡tica?`\n        *(envia a quarta mensagem)*\n\n** NÃƒO FAÃ‡A ISSO (FORMATO ERRADO âŒ):\n        `OlÃ¡! Com nossas soluÃ§Ãµes, vocÃª garante: **Agente de Atendimento Inteligente:** Responde perguntas... **ComunicaÃ§Ã£o Mais Limpa:** Nossos filtros... **Setup e ImplementaÃ§Ã£o:** NÃ³s cuidamos... **ManutenÃ§Ã£o e Suporte:** Garantimos que...`\n\nRegras de ConteÃºdo e Atendimento\nFonte da Verdade: Para CADA pergunta sobre os serviÃ§os (preÃ§os, exemplos de automaÃ§Ã£o, filtros de spam, benefÃ­cios, etc.), consulte SEMPRE a tool dsb_solution para obter as informaÃ§Ãµes oficiais e responda com base nesse conteÃºdo.\n\nEscopo de AtuaÃ§Ã£o: Seu foco Ã© vender e dar suporte a automaÃ§Ãµes. Se perguntarem algo fora deste escopo, redirecione educadamente a conversa para como a automaÃ§Ã£o pode ajudar o negÃ³cio da pessoa.\n\nClarificaÃ§Ã£o: Se a dÃºvida nÃ£o estiver clara, faÃ§a uma pergunta simples para entender a necessidade do cliente. Ex: \"Para qual processo vocÃª busca uma automaÃ§Ã£o?\" ou \"Qual tarefa repetitiva vocÃª gostaria de eliminar?\".\n\nEscalonamento Humano: Caso nÃ£o saiba responder mesmo apÃ³s consultar o documento, ou se o cliente pedir explicitamente para falar com um humano, direcione-o para o especialista Diego Sousa pelo WhatsApp (64) 993174450.\n\nProatividade: Seja direto e prÃ¡tico. Seu objetivo Ã© resolver a dÃºvida e incentivar o prÃ³ximo passo, que Ã© agendar uma consultoria.\n\n(As seÃ§Ãµes \"Oferecer Consultoria Gratuita\", \"Uso das Tools de CalendÃ¡rio\" e \"Exemplos de Resposta\" permanecem as mesmas, pois jÃ¡ sÃ£o excelentes.)"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -864,
        160
      ],
      "id": "3200c749-fb23-469c-8e11-8b21d239c89f",
      "name": "AI Agent",
      "retryOnFail": false,
      "waitBetweenTries": 5000,
      "maxTries": 3
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.instagram.com/v22.0/{you_id}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {your_key}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "recipient.id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}"
            },
            {
              "name": "message.text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -464,
        160
      ],
      "id": "98e8c95d-93f4-4278-ab60-76f862d72111",
      "name": "HTTP Request",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "diegosousa977@gmail.com",
          "mode": "list",
          "cachedResultName": "diegosousa977@gmail.com"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', ``, 'string') }}"
          ],
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', ``, 'string') }}",
          "summary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -512,
        416
      ],
      "id": "93056219-f68e-4802-b7e4-ad1c2bfa366b",
      "name": "cria evento",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "wYHbsxdf3AuOr8xY",
          "name": "Google Calendar D977"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "diegosousa977@gmail.com",
          "mode": "list",
          "cachedResultName": "diegosousa977@gmail.com"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -512,
        544
      ],
      "id": "49324a8e-8709-4a46-b7e6-d62b36bff6f0",
      "name": "consulta evento",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "wYHbsxdf3AuOr8xY",
          "name": "Google Calendar D977"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.entry[0].id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -880,
        544
      ],
      "id": "14ed2061-8722-4df2-a51d-e7047780dc5d",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "content": "## Prevent auto-review of messages. Enter your Instagram ID.",
        "height": 320,
        "width": 272
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1536,
        64
      ],
      "id": "f7a73f8f-d989-4310-a458-01bf86d85c03",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## To config",
        "height": 208,
        "width": 272
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1536,
        -160
      ],
      "id": "2f3c6af8-02bb-40e0-9f04-ba0d2fef798e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Input",
        "height": 320,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1792,
        64
      ],
      "id": "f2678df6-e828-44c7-97f4-b0a2dd784200",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Analyzing messages",
        "height": 400,
        "width": 208,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -960,
        304
      ],
      "id": "ff3605c1-a1b9-4a85-a287-3191f571d95c",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## knowledge base",
        "height": 352,
        "width": 150,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -736,
        352
      ],
      "id": "604937f0-c49a-438a-933b-2e20b9e77290",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Create event",
        "height": 352,
        "width": 224,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -560,
        352
      ],
      "id": "4e74006f-3adb-4c60-b2f4-dd7fdc78ebfc",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Return user",
        "height": 256,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -512,
        64
      ],
      "id": "22b5f38e-2df7-4bae-b627-3ef8bd15985f",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "1vNkqhuEctKJ9oPxK_CxjS1fLiIk3dbWTqDAqFX9_JQ0"
      },
      "type": "n8n-nodes-base.googleDocsTool",
      "typeVersion": 2,
      "position": [
        -704,
        432
      ],
      "id": "1c8d7659-0145-43a8-8140-5ffb24ec36bc",
      "name": "dsb_solution",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "opPp1yEJxVfxoMFN",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const text = $input.item.json.output;\nconst limit = 999;\nconst messages = [];\nlet remainingText = text;\n\n// Loop para dividir todo o texto em partes de atÃ© 4096 caracteres\nwhile (remainingText.length > 0) {\n  const chunk = remainingText.substring(0, limit);\n  messages.push({\n    json: {\n      text: chunk\n    }\n  });\n  remainingText = remainingText.substring(limit);\n}\n\nreturn messages;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        176
      ],
      "id": "f217868f-17b9-4767-aa51-705c3362fa67",
      "name": "Code_factory"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.instagram.com/v22.0/17841431938621895/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer IGAAcXIb0eZCxpBZAE91VlRIVTQxQk9DV3JSd0M2dW0tcm9TalBQX0I3NzF2X09pbTZAubExScm4xYm84dG82REd0YkRHS2tnQ280aG4weHMtYm8zU2E3RkJuTW1oVDdYM3lSUlJ6YTc0TWZALT29aMld2LUJ5eUxnb3FETmJYNFdXTQZDZD"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "recipient.id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}"
            },
            {
              "name": "message.text",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32,
        176
      ],
      "id": "7bb96669-edba-4f91-929b-1698eee74794",
      "name": "HTTP Request1",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "content": "## Return user",
        "height": 256,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -16,
        80
      ],
      "id": "7b4fc1a9-78fd-47b8-b68c-b1ecebf20d06",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -880,
        400
      ],
      "id": "0c0f1b10-5600-451c-b316-277c4f335d52",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "d3Tnyg2zaYc0yG1N",
          "name": "Google Gemini D977"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "17cdd8f2-7b60-4791-b421-c8e58ba63fa6",
              "leftValue": "={{ $json.headers['user-agent'] }}",
              "rightValue": "facebookexternalua",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1168,
        176
      ],
      "id": "76499cf7-1cf2-4de5-9b31-349addbd8ae9",
      "name": "Instagran_sender?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "28e0921b-8208-4a70-a017-8238f8df4bc2",
              "leftValue": "={{ $json.body.entry[0].messaging[0].sender.id }}",
              "rightValue": "17841431938621895",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1440,
        192
      ],
      "id": "bd19cb18-babf-4443-a441-1ce1c9ff1c33",
      "name": "Its_me?"
    },
    {
      "parameters": {
        "content": "## Did the Webhook pick up any signals from instagram ?",
        "height": 320,
        "width": 256,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1248,
        64
      ],
      "id": "b33f62ab-a320-476f-9fb9-023a81bfec74",
      "name": "Sticky Note8"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "connection": "keep-alive",
            "host": "n8n-diego.dsbdocker.shop",
            "x-forwarded-scheme": "https",
            "x-forwarded-proto": "https",
            "x-forwarded-for": "172.18.0.1",
            "x-real-ip": "172.18.0.1",
            "content-length": "861",
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "user-agent": "axios/1.10.0",
            "accept-encoding": "gzip, compress, deflate, br"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "whatsapp-diego",
            "data": {
              "key": {
                "remoteJid": "556493174450@s.whatsapp.net",
                "fromMe": false,
                "id": "AC1E287ABD1CE80AC3C81538574B8BCB"
              },
              "pushName": null,
              "status": "DELIVERY_ACK",
              "message": {
                "conversation": "Registre sua nova despesa de energia no valor de r$ 25"
              },
              "contextInfo": {
                "expiration": 7776000,
                "ephemeralSettingTimestamp": "1731805198",
                "disappearingMode": {
                  "initiator": "CHANGED_IN_CHAT",
                  "trigger": "CHAT_SETTING"
                }
              },
              "messageType": "conversation",
              "messageTimestamp": 1756932121,
              "instanceId": "d8a5e6c8-d55e-4520-afa0-b478dddce3d1",
              "source": "android"
            },
            "destination": "https://n8n-diego.dsbdocker.shop/webhook/2579c46d-780a-4d3c-87e8-f54f9de43cf8",
            "date_time": "2025-09-03T17:42:08.237Z",
            "sender": "556496538016@s.whatsapp.net",
            "server_url": "https://debianserver.tail4dd07c.ts.net/evolution/",
            "apikey": "F7F37AF3F173-4309-9ED5-C8384E69CE8D"
          },
          "webhookUrl": "https://n8n-diego.dsbdocker.shop/webhook/2579c46d-780a-4d3c-87e8-f54f9de43cf8",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Its_me?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria evento": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consulta evento": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "dsb_solution": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [],
        [
          {
            "node": "Code_factory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code_factory": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Instagran_sender?": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Its_me?": {
      "main": [
        [
          {
            "node": "Instagran_sender?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 90,
    "timeSavedPerExecution": 5,
    "errorWorkflow": "pg8ALIIg5c67G45X"
  },
  "versionId": "893370af-4a6f-475c-a439-11b66a336c47",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "e850d0c6aabc26b2018bc6148b0e9c4bf40af3ef3090ce6809e83bfceb4b35c8"
  },
  "id": "YMULQStclH6yXvyT",
  "tags": []
}